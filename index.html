<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä»•è¨³deã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ - å…¨å•†2ç´šãƒ»ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå¯¾å¿œç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DotGothic16&family=Noto+Sans+JP:wght@400;700&display=swap');
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f0f2f5;
            touch-action: manipulation;
        }

        .pixel-font {
            font-family: 'DotGothic16', sans-serif;
        }

        .card-animate {
            transition: all 0.2s ease-out;
            user-select: none;
            touch-action: none;
        }

        .drop-zone {
            min-height: 120px;
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            background-color: rgba(255,255,255,0.5);
            transition: background-color 0.2s;
        }

        .drop-zone.drag-over {
            background-color: rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
        }

        .inventory-scroll {
            max-height: 40vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .dragging {
            opacity: 0.5;
            transform: scale(1.1);
            z-index: 1000;
        }

        /* QRã‚³ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ */
        #qr-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
    </style>
</head>
<body class="p-2 md:p-8">
    <div id="app" class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="flex justify-between items-center mb-4 bg-white p-4 md:p-6 rounded-2xl shadow-sm border-b-4 border-red-500">
            <div>
                <h1 class="text-xl md:text-3xl font-bold text-red-800 pixel-font">ä»•è¨³deã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³</h1>
                <p class="text-[10px] md:text-sm text-gray-500 font-bold">å…¨å•†2ç´š ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆæœ€é©åŒ–ç‰ˆ</p>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="showQRCode()" class="bg-gray-100 p-2 rounded-lg hover:bg-gray-200 transition-colors" title="ã“ã®ã‚¢ãƒ—ãƒªã®QRã‚’è¡¨ç¤º">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="5" height="5" x="3" y="3" rx="1"/><rect width="5" height="5" x="16" y="3" rx="1"/><rect width="5" height="5" x="3" y="16" rx="1"/><path d="M21 16h-3a2 2 0 0 0-2 2v3"/><path d="M21 21v.01"/><path d="M12 7v3a2 2 0 0 1-2 2H7"/><path d="M3 12h.01"/><path d="M12 3h.01"/><path d="M12 16v.01"/><path d="M16 12h1"/><path d="M21 12v.01"/><path d="M12 21v.01"/></svg>
                </button>
                <div class="text-right">
                    <div class="text-[10px] text-gray-400">äºˆç®—æ®‹é«˜</div>
                    <div class="text-lg md:text-2xl font-bold text-orange-600" id="current-balance">Â¥3,000,000</div>
                </div>
            </div>
        </header>

        <!-- QR Modal -->
        <div id="qr-modal" onclick="closeQRCode()">
            <div class="bg-white p-8 rounded-2xl text-center space-y-4" onclick="event.stopPropagation()">
                <h3 class="font-bold text-lg">å…±æœ‰ç”¨QRã‚³ãƒ¼ãƒ‰</h3>
                <div id="qrcode-container" class="flex justify-center p-4 bg-white"></div>
                <p class="text-xs text-gray-500">ã“ã®ãƒšãƒ¼ã‚¸ã‚’Webå…¬é–‹ã™ã‚‹ã¨ã€<br>ã“ã®QRã§ä»–ã®ç«¯æœ«ã‹ã‚‰ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚</p>
                <button onclick="closeQRCode()" class="w-full py-2 bg-gray-800 text-white rounded-xl font-bold">é–‰ã˜ã‚‹</button>
            </div>
        </div>

        <!-- Main Game Area -->
        <div id="game-container">
            <!-- Phase 1: Auction -->
            <div id="auction-phase" class="space-y-4">
                <div class="bg-gray-50 p-4 md:p-6 rounded-2xl border-2 border-gray-300 text-center relative">
                    <h2 class="text-sm md:text-xl font-bold text-gray-700 mb-2 italic">ğŸ“¢ ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³é–‹å‚¬ä¸­</h2>
                    <div id="auction-item" class="inline-block bg-white p-4 md:p-8 rounded-xl shadow-xl border-4 border-orange-400 mb-4 w-48 h-64 md:w-64 md:h-80 flex flex-col justify-center items-center relative overflow-hidden card-animate">
                        <span id="item-type" class="absolute top-2 left-2 text-[10px] font-bold px-2 py-1 rounded">è³‡ç”£</span>
                        <div id="item-icon" class="text-4xl md:text-6xl mb-4">ğŸ’°</div>
                        <div id="item-name" class="text-lg md:text-2xl font-bold text-gray-800">ç¾é‡‘</div>
                        <div id="item-desc" class="text-[10px] text-gray-400 mt-2 text-center px-2">æœ€ã‚‚åŸºæœ¬çš„ãªè³‡ç”£ã§ã™</div>
                    </div>
                    <div class="flex flex-col items-center gap-2">
                        <div class="flex justify-center gap-4">
                            <button onclick="bid(200000)" id="btn-bid" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 md:px-10 rounded-full shadow-lg transition-all active:scale-90 disabled:opacity-50">Â¥200,000ã§å…¥æœ­</button>
                            <button onclick="passItem()" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-6 md:px-10 rounded-full shadow-lg transition-all active:scale-90">è¦‹é€ã‚Š</button>
                        </div>
                        <p class="text-[10px] text-red-500 font-bold" id="money-warning"></p>
                    </div>
                    <p class="mt-2 text-xs text-gray-600 font-bold">æ®‹ã‚Šã‚¢ã‚¤ãƒ†ãƒ : <span id="items-left">30</span>/30</p>
                </div>

                <div class="bg-white p-4 rounded-2xl shadow-sm">
                    <h3 class="text-sm font-bold text-gray-700 mb-2">ä¿æœ‰ä¸­ã®å‹˜å®šç§‘ç›®</h3>
                    <div id="inventory" class="flex flex-wrap gap-2 md:gap-4 min-h-[80px] inventory-scroll p-1">
                    </div>
                </div>
                
                <div class="flex justify-center p-4">
                    <button id="start-settlement" onclick="startSettlement()" class="hidden bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-10 rounded-xl text-lg md:text-xl shadow-xl animate-bounce">
                        æ±ºç®—æ•´ç†ï¼ˆä»•è¨³æ§‹ç¯‰ï¼‰ã¸ â”
                    </button>
                </div>
            </div>

            <!-- Phase 2: Settlement -->
            <div id="settlement-phase" class="hidden space-y-4">
                <div class="text-center mb-2">
                    <h2 class="text-lg md:text-2xl font-bold text-green-700">âœï¸ æ±ºç®—æ•´ç†ä»•è¨³</h2>
                    <p class="text-[10px] text-gray-600 italic">ã‚«ãƒ¼ãƒ‰ã‚’é•·æŠ¼ã—/ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦å„ã‚¨ãƒªã‚¢ã¸é…ç½®ï¼</p>
                </div>

                <div class="grid grid-cols-2 gap-2 md:gap-8">
                    <div class="bg-red-50 p-3 rounded-xl border-t-4 border-red-400">
                        <div class="flex justify-between items-center mb-2 flex-wrap">
                            <h3 class="text-xs md:text-sm font-bold text-red-700">å€Ÿæ–¹ (Dr.)</h3>
                            <span id="debit-total" class="text-[10px] md:text-sm font-bold text-red-600">Â¥0</span>
                        </div>
                        <div id="debit-zone" class="drop-zone p-2 flex flex-wrap gap-1" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                    </div>
                    <div class="bg-blue-50 p-3 rounded-xl border-t-4 border-blue-400">
                        <div class="flex justify-between items-center mb-2 flex-wrap">
                            <h3 class="text-xs md:text-sm font-bold text-blue-700">è²¸æ–¹ (Cr.)</h3>
                            <span id="credit-total" class="text-[10px] md:text-sm font-bold text-blue-600">Â¥0</span>
                        </div>
                        <div id="credit-zone" class="drop-zone p-2 flex flex-wrap gap-1" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                    </div>
                </div>

                <div class="bg-gray-100 p-4 rounded-2xl">
                    <h3 class="text-xs md:text-sm font-bold mb-2">æ‰‹å…ƒã®ã‚«ãƒ¼ãƒ‰</h3>
                    <div id="pool-zone" class="flex flex-wrap gap-2 min-h-[100px]" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                </div>

                <div class="flex justify-center pb-8">
                    <button onclick="calculateResult()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-8 rounded-xl text-lg shadow-xl active:scale-95">
                        æ±ºç®—ç¢ºå®šï¼ˆB/Sãƒ»P/Lä½œæˆï¼‰
                    </button>
                </div>
            </div>

            <!-- Phase 3: Result -->
            <div id="result-phase" class="hidden text-center space-y-6 bg-white p-6 md:p-12 rounded-3xl shadow-2xl border-4 md:border-8 border-double border-blue-200">
                <div class="pixel-font text-3xl md:text-5xl text-blue-600 mb-2" id="result-status">COMPLETED</div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                    <div class="p-3 bg-blue-50 rounded-xl">
                        <div class="text-[10px] text-gray-500">å½“æœŸç·åç›Š</div>
                        <div class="text-lg md:text-2xl font-bold text-blue-600" id="res-revenue">Â¥0</div>
                    </div>
                    <div class="p-3 bg-red-50 rounded-xl">
                        <div class="text-[10px] text-gray-500">å½“æœŸç·è²»ç”¨</div>
                        <div class="text-lg md:text-2xl font-bold text-red-600" id="res-expense">Â¥0</div>
                    </div>
                    <div class="p-3 bg-orange-100 rounded-xl border-2 border-orange-300">
                        <div class="text-[10px] text-gray-600 font-bold">å½“æœŸç´”åˆ©ç›Š</div>
                        <div class="text-lg md:text-2xl font-black text-orange-600" id="final-profit">Â¥0</div>
                    </div>
                </div>
                <div id="result-details" class="max-w-md mx-auto bg-gray-50 p-4 md:p-6 rounded-xl text-left text-sm space-y-2 border border-gray-200"></div>
                <div class="pt-4">
                    <button onclick="location.reload()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const ITEMS = [
            { id: 1, name: "ç¾é‡‘", type: "è³‡ç”£", icon: "ğŸ’°", desc: "é€šè²¨ä»£ç”¨è¨¼åˆ¸å«ã‚€", value: 500000 },
            { id: 2, name: "å½“åº§é é‡‘", type: "è³‡ç”£", icon: "ğŸ¦", desc: "éŠ€è¡Œã¨ã®å–å¼•å£åº§", value: 800000 },
            { id: 3, name: "å—å–æ‰‹å½¢", type: "è³‡ç”£", icon: "å½¹", desc: "æ‰‹å½¢å‚µæ¨©", value: 600000 },
            { id: 4, name: "å£²æ›é‡‘", type: "è³‡ç”£", icon: "ğŸ“„", desc: "å£²ä¸Šæœªå›åé‡‘", value: 900000 },
            { id: 5, name: "å£²è²·ç›®çš„æœ‰ä¾¡è¨¼åˆ¸", type: "è³‡ç”£", icon: "ğŸ“ˆ", desc: "çŸ­æœŸçš„ãªé‹ç”¨ç›®çš„", value: 400000 },
            { id: 6, name: "è²¸ä»˜é‡‘", type: "è³‡ç”£", icon: "ğŸ¤", desc: "åˆ©æ¯ã‚’ä¼´ã†è²¸å‡º", value: 700000 },
            { id: 7, name: "å»ºç‰©", type: "è³‡ç”£", icon: "ğŸ¢", desc: "æœ‰å½¢å›ºå®šè³‡ç”£", value: 2500000 },
            { id: 8, name: "è»Šä¸¡é‹æ¬å…·", type: "è³‡ç”£", icon: "ğŸšš", desc: "å–¶æ¥­ç”¨ã®è»Š", value: 1200000 },
            { id: 9, name: "ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢", type: "è³‡ç”£", icon: "ğŸ’»", desc: "ç„¡å½¢å›ºå®šè³‡ç”£", value: 300000 },
            { id: 10, name: "æœªååç›Š", type: "è³‡ç”£", icon: "â³", desc: "è¦‹è¶Šè¨ˆä¸Šã‚¢ã‚¤ãƒ†ãƒ ", value: 100000 },
            { id: 11, name: "å‰æ‰•è²»ç”¨", type: "è³‡ç”£", icon: "ğŸ“…", desc: "æ¬¡æœŸã®è²»ç”¨", value: 150000 },
            { id: 12, name: "æ”¯æ‰•æ‰‹å½¢", type: "è² å‚µ", icon: "âœï¸", desc: "æ‰‹å½¢å‚µå‹™", value: 500000 },
            { id: 13, name: "è²·æ›é‡‘", type: "è² å‚µ", icon: "ğŸ›’", desc: "ä»•å…¥æœªæ‰•é‡‘", value: 800000 },
            { id: 14, name: "é•·æœŸå€Ÿå…¥é‡‘", type: "è² å‚µ", icon: "ğŸ’¸", desc: "1å¹´è¶…ã®å€Ÿé‡‘", value: 1500000 },
            { id: 15, name: "é€€è·çµ¦ä»˜å¼•å½“é‡‘", type: "è² å‚µ", icon: "ğŸ‘´", desc: "è² å‚µæ€§å¼•å½“é‡‘", value: 600000 },
            { id: 16, name: "æœªæ‰•è²»ç”¨", type: "è² å‚µ", icon: "ğŸ“‹", desc: "å½“æœŸã®æœªæ‰•åˆ†", value: 120000 },
            { id: 17, name: "å‰å—åç›Š", type: "è² å‚µ", icon: "ğŸ“¥", desc: "åç›Šã®å‰å—", value: 90000 },
            { id: 18, name: "æ³•äººç¨ç­‰èª¿æ•´é¡", type: "è² å‚µ", icon: "ğŸ›ï¸", desc: "ç¨åŠ¹æœä¼šè¨ˆ(è²¸æ–¹æƒ³å®š)", value: 200000 },
            { id: 19, name: "å£²ä¸Š", type: "åç›Š", icon: "ğŸ”¥", desc: "ãƒ¡ã‚¤ãƒ³åç›Š", value: 3000000 },
            { id: 20, name: "å—å–åˆ©æ¯", type: "åç›Š", icon: "ğŸª™", desc: "é‡‘èåç›Š", value: 50000 },
            { id: 21, name: "æœ‰ä¾¡è¨¼åˆ¸è©•ä¾¡ç›Š", type: "åç›Š", icon: "ğŸ’", desc: "æ™‚ä¾¡è©•ä¾¡ã®ç›Š", value: 150000 },
            { id: 22, name: "å›½åº«è£œåŠ©é‡‘å—è´ˆç›Š", type: "åç›Š", icon: "ğŸ‡¯ğŸ‡µ", desc: "æ”¿åºœã‹ã‚‰ã®è£œåŠ©", value: 500000 },
            { id: 23, name: "å›ºå®šè³‡ç”£å£²å´ç›Š", type: "åç›Š", icon: "ğŸ ", desc: "å£²å´ã«ã‚ˆã‚‹åˆ©ç›Š", value: 300000 },
            { id: 24, name: "å—å–é…å½“é‡‘", type: "åç›Š", icon: "ğŸ‡", desc: "æ ªå¼ã®é…å½“", value: 80000 },
            { id: 25, name: "ä»•å…¥", type: "è²»ç”¨", icon: "ğŸ“¦", desc: "å£²ä¸ŠåŸä¾¡ã®æ§‹æˆè¦ç´ ", value: 1800000 },
            { id: 26, name: "çµ¦æ–™", type: "è²»ç”¨", icon: "ğŸ‘”", desc: "äººä»¶è²»", value: 800000 },
            { id: 27, name: "æ¸›ä¾¡å„Ÿå´è²»", type: "è²»ç”¨", icon: "ğŸ“‰", desc: "ä¾¡å€¤ã®æ¸›å°‘åˆ†", value: 400000 },
            { id: 28, name: "è²¸å€’å¼•å½“é‡‘ç¹°å…¥", type: "è²»ç”¨", icon: "âš ï¸", desc: "ãƒªã‚¹ã‚¯ã¸ã®è²»ç”¨åŒ–", value: 70000 },
            { id: 29, name: "æ”¯æ‰•åˆ©æ¯", type: "è²»ç”¨", icon: "âš–ï¸", desc: "è²¡å‹™è²»ç”¨", value: 60000 },
            { id: 30, name: "ç§Ÿç¨å…¬èª²", type: "è²»ç”¨", icon: "ğŸ“œ", desc: "ç¨é‡‘ã‚„å…¬èª²", value: 100000 }
        ];

        let balance = 3000000; 
        let inventory = [];
        let auctionIndex = 0;
        const totalAuctionItems = ITEMS.length;
        const BID_PRICE = 200000;

        let draggedEl = null;
        let activeZones = [];

        window.onload = () => {
            updateDisplay();
            showNextAuctionItem();
            activeZones = [document.getElementById('debit-zone'), document.getElementById('credit-zone'), document.getElementById('pool-zone')];
            // åˆå›ã®QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
            new QRCode(document.getElementById("qrcode-container"), {
                text: window.location.href,
                width: 180,
                height: 180
            });
        };

        function showQRCode() { document.getElementById('qr-modal').style.display = 'flex'; }
        function closeQRCode() { document.getElementById('qr-modal').style.display = 'none'; }

        function updateDisplay() {
            document.getElementById('current-balance').innerText = `Â¥${balance.toLocaleString()}`;
            document.getElementById('items-left').innerText = totalAuctionItems - auctionIndex;
            const bidBtn = document.getElementById('btn-bid');
            const warning = document.getElementById('money-warning');
            if (balance < BID_PRICE) {
                bidBtn.disabled = true;
                warning.innerText = "è³‡é‡‘ä¸è¶³";
            } else {
                bidBtn.disabled = false;
                warning.innerText = "";
            }
        }

        function showNextAuctionItem() {
            const auctionItemEl = document.getElementById('auction-item');
            if (auctionIndex >= totalAuctionItems) {
                auctionItemEl.innerHTML = `<div class="text-sm md:text-xl font-bold p-4">ã‚«ã‚¿ãƒ­ã‚°çµ‚äº†</div>`;
                document.getElementById('start-settlement').classList.remove('hidden');
                document.getElementById('btn-bid').classList.add('hidden');
                return;
            }
            const item = ITEMS[auctionIndex];
            document.getElementById('item-name').innerText = item.name;
            document.getElementById('item-type').innerText = item.type;
            document.getElementById('item-icon').innerText = item.icon;
            document.getElementById('item-desc').innerText = item.desc;
            const typeLabels = { "è³‡ç”£": "bg-green-100 text-green-700", "è² å‚µ": "bg-red-100 text-red-700", "åç›Š": "bg-blue-100 text-blue-700", "è²»ç”¨": "bg-yellow-100 text-yellow-700" };
            document.getElementById('item-type').className = `absolute top-2 left-2 text-[10px] font-bold px-2 py-1 rounded ${typeLabels[item.type] || 'bg-gray-100'}`;
        }

        function bid(amount) {
            if (balance < amount || auctionIndex >= totalAuctionItems) return;
            balance -= amount;
            inventory.push({...ITEMS[auctionIndex]});
            const invDiv = document.getElementById('inventory');
            invDiv.appendChild(createCardElement(ITEMS[auctionIndex]));
            auctionIndex++;
            updateDisplay();
            showNextAuctionItem();
        }

        function passItem() {
            if (auctionIndex >= totalAuctionItems) return;
            auctionIndex++;
            updateDisplay();
            showNextAuctionItem();
        }

        function createCardElement(item, isDraggable = false) {
            const div = document.createElement('div');
            div.className = `p-2 rounded-lg border bg-white shadow-sm flex flex-col items-center w-20 md:w-24 card-animate cursor-move`;
            div.id = `card-${Math.random().toString(36).substr(2, 9)}`;
            div.innerHTML = `
                <div class="text-xl md:text-2xl">${item.icon}</div>
                <div class="text-[8px] md:text-[10px] font-bold truncate w-full text-center">${item.name}</div>
                <div class="text-[8px] text-gray-400">Â¥${item.value.toLocaleString()}</div>
            `;
            div.dataset.itemData = JSON.stringify(item);

            if (isDraggable) {
                div.draggable = true;
                div.ondragstart = (e) => {
                    e.dataTransfer.setData("text/plain", e.target.id);
                    e.target.classList.add('dragging');
                };
                div.ondragend = (e) => e.target.classList.remove('dragging');
                div.addEventListener('touchstart', handleTouchStart, { passive: false });
                div.addEventListener('touchmove', handleTouchMove, { passive: false });
                div.addEventListener('touchend', handleTouchEnd, { passive: false });
            }
            return div;
        }

        function handleTouchStart(e) {
            draggedEl = e.currentTarget;
            draggedEl.classList.add('dragging');
            const touch = e.touches[0];
            draggedEl.dataset.startX = touch.pageX - draggedEl.offsetLeft;
            draggedEl.dataset.startY = touch.pageY - draggedEl.offsetTop;
        }

        function handleTouchMove(e) {
            if (!draggedEl) return;
            e.preventDefault();
            const touch = e.touches[0];
            draggedEl.style.position = 'fixed';
            draggedEl.style.left = (touch.pageX - 40) + 'px';
            draggedEl.style.top = (touch.pageY - 40) + 'px';
            activeZones.forEach(zone => {
                const rect = zone.getBoundingClientRect();
                if (touch.clientX >= rect.left && touch.clientX <= rect.right && touch.clientY >= rect.top && touch.clientY <= rect.bottom) {
                    zone.classList.add('drag-over');
                } else { zone.classList.remove('drag-over'); }
            });
        }

        function handleTouchEnd(e) {
            if (!draggedEl) return;
            draggedEl.classList.remove('dragging');
            const touch = e.changedTouches[0];
            activeZones.forEach(zone => {
                zone.classList.remove('drag-over');
                const rect = zone.getBoundingClientRect();
                if (touch.clientX >= rect.left && touch.clientX <= rect.right && touch.clientY >= rect.top && touch.clientY <= rect.bottom) {
                    zone.appendChild(draggedEl);
                }
            });
            draggedEl.style.position = '';
            draggedEl.style.left = '';
            draggedEl.style.top = '';
            draggedEl = null;
            updateZoneTotals();
        }

        function startSettlement() {
            document.getElementById('auction-phase').classList.add('hidden');
            document.getElementById('settlement-phase').classList.remove('hidden');
            const pool = document.getElementById('pool-zone');
            pool.innerHTML = '';
            inventory.forEach(item => pool.appendChild(createCardElement(item, true)));
        }

        function allowDrop(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
        function drop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            const id = e.dataTransfer.getData("text/plain");
            const el = document.getElementById(id);
            if (el) e.currentTarget.appendChild(el);
            updateZoneTotals();
        }

        function updateZoneTotals() {
            const sum = (id) => Array.from(document.getElementById(id).children).reduce((a, b) => a + JSON.parse(b.dataset.itemData).value, 0);
            document.getElementById('debit-total').innerText = `Â¥${sum('debit-zone').toLocaleString()}`;
            document.getElementById('credit-total').innerText = `Â¥${sum('credit-zone').toLocaleString()}`;
        }

        function calculateResult() {
            const debitItems = Array.from(document.getElementById('debit-zone').children).map(el => JSON.parse(el.dataset.itemData));
            const creditItems = Array.from(document.getElementById('credit-zone').children).map(el => JSON.parse(el.dataset.itemData));
            let dSum = debitItems.reduce((a, b) => a + b.value, 0);
            let cSum = creditItems.reduce((a, b) => a + b.value, 0);
            let rev = inventory.filter(i => i.type === "åç›Š").reduce((a, b) => a + b.value, 0);
            let exp = inventory.filter(i => i.type === "è²»ç”¨").reduce((a, b) => a + b.value, 0);
            const isBalanced = (dSum === cSum && dSum > 0);
            document.getElementById('settlement-phase').classList.add('hidden');
            document.getElementById('result-phase').classList.remove('hidden');
            document.getElementById('res-revenue').innerText = `Â¥${rev.toLocaleString()}`;
            document.getElementById('res-expense').innerText = `Â¥${exp.toLocaleString()}`;
            document.getElementById('final-profit').innerText = `Â¥${(rev - exp).toLocaleString()}`;
            const details = document.getElementById('result-details');
            details.innerHTML = `<div class="flex justify-between"><span>å€Ÿæ–¹åˆè¨ˆ:</span> <span>Â¥${dSum.toLocaleString()}</span></div><div class="flex justify-between"><span>è²¸æ–¹åˆè¨ˆ:</span> <span>Â¥${cSum.toLocaleString()}</span></div><div class="mt-4 font-bold text-center ${isBalanced ? 'text-green-600' : 'text-red-600'}">${isBalanced ? 'ä¸€è‡´ï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼' : 'ä¸ä¸€è‡´ã§ã™ã€‚ä»•è¨³ã‚’å†ç¢ºèªã—ã¦ãã ã•ã„ã€‚'}</div>`;
            document.getElementById('result-status').innerText = isBalanced ? "EXCELLENT" : "FAILED";
        }
    </script>
</body>
</html>